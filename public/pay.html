<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <title>Pay æ”¯ä»˜æˆæƒç¤ºä¾‹ (Ethers v6)</title>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>

    <style>
        body {
            font-family: "JetBrains Mono", monospace;
            background: #0d1117;
            color: #c9d1d9;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            gap: 16px;
        }
        .card {
            background: #161b22;
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #30363d;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        /* æ”¯ä»˜æŒ‰é’®æ ·å¼ */
        button {
            padding: 12px 24px;
            background: #238636;
            border: none;
            color: #fff;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        button:hover { background: #2ea043; }
        #status {
            padding: 8px 16px;
            margin-top: 15px;
            background: #0d1117;
            border-radius: 8px;
            min-height: 20px;
            text-align: center;
            border: 1px solid #30363d;
        }
        .data-box {
            margin-top: 20px;
            padding: 15px;
            background: #0d1117;
            border-radius: 8px;
            text-align: left;
            border: 1px solid #30363d;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="card">
    <h2>9Pay æ”¯ä»˜æˆæƒç¤ºä¾‹</h2>
    <div id="status">ç­‰å¾…æ“ä½œ...</div>
    <button id="payButton">æ£€æŸ¥æˆæƒä¸­...</button>
    <div id="dataBox" class="data-box hidden"></div>
</div>

<script>
    // âš ï¸ ç¡®ä¿åç«¯è¿è¡Œåœ¨ http://localhost:3002

    document.addEventListener('DOMContentLoaded', () => {
        // å¯åŠ¨æ—¶æ£€æŸ¥ Ethers åº“æ˜¯å¦åŠ è½½
        if (typeof ethers === 'undefined' || typeof ethers.BrowserProvider === 'undefined') {
            document.getElementById('status').textContent = "âš ï¸ é”™è¯¯ï¼šethers.js åº“æœªèƒ½åŠ è½½ã€‚è¯·æ£€æŸ¥ç½‘ç»œã€‚";
            return;
        }

        const API_RESOURCE_URL = 'http://localhost:3002/api/weather';
        const JWT_STORAGE_KEY = 'jwt_token';
        const statusBox = document.getElementById('status');
        const payButton = document.getElementById('payButton');
        const dataBox = document.getElementById('dataBox');

        let signerInstance = null; // Ethers Signer å®ä¾‹

        function updateStatus(msg, type = 'info') {
          statusBox.textContent = msg;
          if (type === 'error') statusBox.style.color = '#f85149';
          else if (type === 'success') statusBox.style.color = '#3fb950';
          else statusBox.style.color = '#c9d1d9';
        }

        async function fetchWithJWT() {
          const jwt = sessionStorage.getItem(JWT_STORAGE_KEY);
          const headers = jwt ? { 'Authorization': 'Bearer ' + jwt } : {};
          // redirect: "manual" ç”¨äºæ•è· 402/401 å“åº”
          const res = await fetch(API_RESOURCE_URL, { headers, redirect: "manual" });
          return res;
        }

        async function attemptWithJWT() {
          payButton.disabled = true;
          dataBox.classList.add('hidden');

          try {
            updateStatus('ğŸŒ æ­£åœ¨æ£€æŸ¥æˆæƒçŠ¶æ€...', 'info');
            const res = await fetchWithJWT();

            const status = res.status;

            if (status === 200) {
              const data = await res.json();
              dataBox.textContent = JSON.stringify(data, null, 2);
              dataBox.classList.remove('hidden');
              updateStatus('âœ… èµ„æºè·å–æˆåŠŸï¼', 'success');
              payButton.classList.add('hidden'); // æˆåŠŸåéšè—æŒ‰é’®
              return;
            }

            if (status === 402) {
              payButton.classList.remove('hidden');
              payButton.textContent = 'è¿æ¥é’±åŒ…å¹¶æ”¯ä»˜';
              payButton.disabled = false;
              updateStatus('ğŸ’° æ£€æµ‹åˆ°èµ„æºéœ€æ”¯ä»˜ï¼Œè¯·è¿æ¥é’±åŒ…ã€‚', 'info');
              return;
            }

            if (status === 401) {
              sessionStorage.removeItem(JWT_STORAGE_KEY);
              updateStatus('âš ï¸ æˆæƒè¿‡æœŸï¼Œè¯·ç‚¹å‡»æŒ‰é’®é‡æ–°æ”¯ä»˜ã€‚', 'error');
              payButton.classList.remove('hidden');
              payButton.textContent = 'é‡æ–°è¿æ¥å¹¶æ”¯ä»˜';
              payButton.disabled = false;
            } else if (status > 402 || status < 200) {
              updateStatus(`âŒ API è¿”å›æœªçŸ¥çŠ¶æ€: ${status}`, 'error');
              payButton.classList.remove('hidden');
              payButton.textContent = 'é‡è¯•';
              payButton.disabled = false;
            }
          } catch (err) {
            console.error("Attempt failed:", err);
            updateStatus('âŒ è¯·æ±‚å¤±è´¥: ' + (err.message || 'ç½‘ç»œè¿æ¥æˆ–CORSé”™è¯¯'), 'error');
            payButton.classList.remove('hidden');
            payButton.textContent = 'é‡è¯•';
            payButton.disabled = false;
          }
        }

        async function connectAndSettle() {
          payButton.disabled = true;
          try {
            // 1. è¿æ¥é’±åŒ…å’Œè·å–ç­¾åè€…
            if (!window.ethereum) throw new Error("æœªæ£€æµ‹åˆ°é’±åŒ…ï¼Œè¯·å®‰è£… MetaMask æˆ–å¯ç”¨ EVM é’±åŒ…ã€‚");

            if (!signerInstance) {
                 updateStatus('ğŸ”Œ æ­£åœ¨è¯·æ±‚é’±åŒ…è¿æ¥æˆæƒ...', 'info');
                 await window.ethereum.request({ method: 'eth_requestAccounts' });
                 updateStatus('ğŸ—‚ï¸ æ­£åœ¨åˆå§‹åŒ–é’±åŒ…æä¾›è€…...', 'info');
                 const provider = new ethers.BrowserProvider(window.ethereum);
                 signerInstance = await provider.getSigner();
            }

            const address = await signerInstance.getAddress();
            updateStatus('ğŸ‘› é’±åŒ…å·²è¿æ¥ï¼š' + address.slice(0, 6) + '...', 'success');

            // 2. å†æ¬¡è¯·æ±‚ 402 å¹¶è·å–æœ€æ–°çš„æ”¯ä»˜æˆæƒæ¶ˆæ¯
            updateStatus('ğŸ“„ è¯·æ±‚æ”¯ä»˜æˆæƒæ¶ˆæ¯...', 'info');
            const payReq = await fetch(API_RESOURCE_URL, { redirect: "manual" });

            if (payReq.status !== 402) {
                 throw new Error(`API çŠ¶æ€é”™è¯¯ï¼ŒæœŸæœ› 402ï¼Œå®é™… ${payReq.status}`);
            }

            // ğŸŒŸ æ ¸å¿ƒä¿®å¤ï¼šä»å“åº”ä½“ä¸­è§£æ paymentMessage
            const payBody = await payReq.json();
            let paymentMessage = payBody.paymentMessage;

            if (!paymentMessage) {
                // å¦‚æœ body ä¸­æ²¡æœ‰ï¼Œæ£€æŸ¥ headers (ä»¥é˜²ä¸‡ä¸€)
                const headerMessage = payReq.headers.get('x-payment-message');
                if (!headerMessage) {
                    throw new Error('API å“åº”ä½“å’Œå¤´éƒ¨å‡æœªæä¾› X-Payment-Messageã€‚');
                }
                paymentMessage = headerMessage;
            }

            // 3. ç­¾åæˆæƒ
            updateStatus('ğŸ–Šï¸ ç­‰å¾…ç­¾åæˆæƒï¼ˆè¯·æ£€æŸ¥é’±åŒ…å¼¹å‡ºçª—å£ï¼‰...', 'info');
            const signature = await signerInstance.signMessage(paymentMessage);

            // 4. æäº¤ç­¾åç»™åç«¯ç»“ç®— (POST è¯·æ±‚)
            updateStatus('ğŸ“¡ æ­£åœ¨æäº¤ç­¾åå’Œæ”¯ä»˜ç»“ç®—...', 'info');
            const response = await fetch(API_RESOURCE_URL, {
              method: 'POST',
              headers: {
                // æäº¤é’±åŒ…ç­¾å
                'X-Payment': signature,
                // æäº¤åŸå§‹ç­¾åæ¶ˆæ¯
                'X-Payment-Message': paymentMessage,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({})
            });

            if (response.ok) {
              // æˆåŠŸç»“ç®—ï¼Œè·å– JWT æ”¶æ®
              const jwt = response.headers.get('x-payment-receipt');
              if (!jwt) throw new Error("æœåŠ¡å™¨æœªè¿”å›æœ‰æ•ˆçš„ JWT æ”¶æ®ã€‚");
              sessionStorage.setItem(JWT_STORAGE_KEY, jwt);
              updateStatus('ğŸ‰ æ”¯ä»˜æˆåŠŸï¼æ­£åœ¨è®¿é—®èµ„æº...', 'success');
              setTimeout(attemptWithJWT, 1000); // 1ç§’åè‡ªåŠ¨è·å–èµ„æº
            } else {
              // æ”¯ä»˜ç»“ç®—å¤±è´¥ï¼Œæ£€æŸ¥é”™è¯¯ä¿¡æ¯
              const errorBody = await response.json().catch(() => ({}));
              const errorMessage = errorBody.message || errorBody.error || `Status ${response.status}`;
              throw new Error(`æ”¯ä»˜ç»“ç®—å¤±è´¥: ${errorMessage}`);
            }
          } catch (err) {
            payButton.disabled = false;
            console.error(err);
            // å‹å¥½çš„é”™è¯¯æç¤º
            const displayError = err.message && err.message.includes("User rejected") ? "ç”¨æˆ·æ‹’ç»è¿æ¥/ç­¾åã€‚" : err.message;
            updateStatus('âŒ æ“ä½œå¤±è´¥: ' + displayError, 'error');
          }
        }

        // ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œè§¦å‘æ”¯ä»˜æˆ–é‡è¯•æ£€æŸ¥
        payButton.addEventListener('click', () => {
            if (payButton.textContent.includes('è¿æ¥é’±åŒ…å¹¶æ”¯ä»˜') || payButton.textContent.includes('é‡æ–°è¿æ¥å¹¶æ”¯ä»˜')) {
                connectAndSettle();
            } else {
                attemptWithJWT();
            }
        });

        // é¡µé¢åŠ è½½åè‡ªåŠ¨æ£€æµ‹æˆæƒçŠ¶æ€
        attemptWithJWT();
    });
</script>
</body>
</html>
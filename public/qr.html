<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WalletConnect Base Sepolia æ‰«ç ç­¾å (V2 å®Œæ•´ä¿®å¤ç‰ˆ)</title>
<style>
body {
    font-family: sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    margin: 0;
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}
.container {
    background: #fff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    max-width: 500px;
    width: 100%;
    text-align: center;
}
h1 {
    color: #0052FF;
    margin-bottom: 10px;
    font-size: 1.8em;
}
.network-info {
    background: #f0f7ff;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 20px;
    font-size: 0.9em;
    color: #0052FF;
}
button {
    background: #0052FF;
    color: #fff;
    border: none;
    padding: 12px 25px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    width: 100%;
    transition: background 0.3s;
    margin-top: 10px;
}
button:hover:not(:disabled) {
    background: #0041CC;
}
button:disabled {
    background: #ccc;
    cursor: not-allowed;
}
.status-box {
    margin-top: 20px;
    padding: 15px;
    border-radius: 8px;
    text-align: left;
}
.status-pending {
    background: #fff3cd;
    border: 1px solid #ffeeba;
    color: #856404;
}
.status-success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}
.status-error {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}
.status-info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
}
#qrcode-display {
    margin-top: 20px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    text-align: center;
}
#result-data {
    margin-top: 20px;
    text-align: left;
    background: #e9ecef;
    padding: 15px;
    border-radius: 8px;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 0.9em;
    font-family: monospace;
}
.debug-log {
    margin-top: 20px;
    padding: 15px;
    background: #2d2d2d;
    color: #00ff00;
    border-radius: 8px;
    text-align: left;
    font-family: monospace;
    font-size: 0.8em;
    max-height: 200px;
    overflow-y: auto;
    display: none;
}
</style>

<!-- ä½¿ç”¨æ­£ç¡®çš„ WalletConnect V2 CDN é“¾æ¥ -->
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@2.9.3/dist/umd/index.min.js"></script>
<script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
</head>
<body>
<div class="container">
    <h1>ğŸ” Base Sepolia æ‰«ç ç­¾å (V2)</h1>
    <div class="network-info">
        <strong>ç½‘ç»œ:</strong> Base Sepolia Testnet<br>
        <strong>Chain ID:</strong> 84532
    </div>
    <p>ä½¿ç”¨ WalletConnect V2.0 è¿æ¥ MetaMask é’±åŒ…å¹¶ç­¾å</p>

    <button id="connect-button" disabled>
        <span id="button-text">åŠ è½½ä¸­...</span>
    </button>

    <div id="wallet-status" class="status-box" style="display:none">
        <span id="status-message"></span>
    </div>

    <div id="qrcode-display"></div>
    <div id="result-data" style="display:none"></div>
    <div id="debug-log" class="debug-log"></div>
</div>

<script>
// ä½¿ç”¨ä½ æä¾›çš„ PROJECT_ID
const PROJECT_ID = '88a44136b0f0a1737379214c4419eebf';

// Base Sepolia é…ç½®
const BASE_SEPOLIA_CONFIG = {
    chainId: 84532,
    rpcUrl: 'https://sepolia.base.org',
    name: 'Base Sepolia',
};

const API_URL = "http://localhost:3002/api/weather";
const connectButton = document.getElementById('connect-button');
const buttonText = document.getElementById('button-text');
const statusBox = document.getElementById('wallet-status');
const statusMessage = document.getElementById('status-message');
const resultBox = document.getElementById('result-data');
const debugLog = document.getElementById('debug-log');
const qrcodeDisplay = document.getElementById('qrcode-display');

let wcProvider = null;

// è°ƒè¯•æ—¥å¿—
function addDebugLog(msg, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'ğŸ“';
    logEntry.textContent = `[${timestamp}] ${prefix} ${msg}`;
    if (type === 'error') logEntry.style.color = '#ff6b6b';
    if (type === 'success') logEntry.style.color = '#51cf66';
    debugLog.appendChild(logEntry);
    debugLog.scrollTop = debugLog.scrollHeight;
    debugLog.style.display = 'block';
    console.log(msg);
}

function updateStatus(msg, className) {
    statusBox.className = `status-box ${className}`;
    statusMessage.innerHTML = msg;
    statusBox.style.display = 'block';
}

function setButtonState(text, disabled = false) {
    buttonText.textContent = text;
    connectButton.disabled = disabled;
}

// è·å–å¾…ç­¾åæ¶ˆæ¯
async function fetchPaymentMessage() {
    updateStatus("æ­£åœ¨è·å–æ”¯ä»˜æ¶ˆæ¯...", 'status-pending');
    addDebugLog('æ­£åœ¨è¯·æ±‚ API: ' + API_URL);

    try {
        const res = await fetch(API_URL);
        addDebugLog('API å“åº”çŠ¶æ€: ' + res.status);

        if (res.status === 402) {
            const msg = res.headers.get('x-payment-message') || 'å¾…ç­¾åæ¶ˆæ¯';
            addDebugLog('è·å–åˆ°å¾…ç­¾åæ¶ˆæ¯: ' + msg, 'success');
            updateStatus(`âœ… è·å–æˆåŠŸï¼Œç‚¹å‡»æŒ‰é’®æ‰«ç ç­¾å`, 'status-success');
            return msg;
        } else if (res.status === 200) {
            const data = await res.json();
            addDebugLog('API å·²æˆæƒ', 'success');
            updateStatus("âœ… API å·²æˆæƒï¼Œæ— éœ€é‡å¤ç­¾å", 'status-success');
            resultBox.style.display = 'block';
            resultBox.textContent = JSON.stringify(data, null, 2);
            setButtonState('å·²æˆæƒ', true);
            return null;
        } else {
            addDebugLog(`æœåŠ¡å™¨è¿”å›é”™è¯¯çŠ¶æ€: ${res.status}`, 'error');
            updateStatus(`âŒ æœåŠ¡å™¨è¿”å›é”™è¯¯çŠ¶æ€: ${res.status}`, 'status-error');
            return null;
        }
    } catch (e) {
        addDebugLog(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${e.message}`, 'error');
        updateStatus(`âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥: ${e.message}`, 'status-error');
        return null;
    }
}

// æ ¸å¿ƒåŠŸèƒ½ï¼šV2 Provider è¿æ¥å’Œç­¾å
async function connectAndSign(paymentMessage) {
    try {
        setButtonState('è¿æ¥ä¸­...', true);
        addDebugLog('å¼€å§‹åˆå§‹åŒ– WalletConnect Provider V2...');

        // è°ƒè¯•ï¼šæŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„å…¨å±€å˜é‡
        const walletGlobals = Object.keys(window).filter(key =>
            key.toLowerCase().includes('wallet') || key.includes('Connect'));
        addDebugLog('å¯ç”¨çš„å…¨å±€å˜é‡: ' + walletGlobals.join(', '));

        // å°è¯•å¤šç§å¯èƒ½çš„æ„é€ å‡½æ•°åç§°
        const WCProviderConstructor =
            window.WalletConnectWeb3Provider ||
            window.WalletConnectProvider ||
            (window.WalletConnectProvider && window.WalletConnectProvider.default) ||
            (window.WalletConnectWeb3Provider && window.WalletConnectWeb3Provider.default);

        if (typeof WCProviderConstructor !== 'function') {
            throw new Error("WalletConnectProvider æ„é€ å‡½æ•°æœªæ‰¾åˆ°ã€‚å°è¯•çš„å˜é‡: " +
                walletGlobals.join(', '));
        }

        // 1. åˆå§‹åŒ– Provider
        wcProvider = new WCProviderConstructor({
            projectId: PROJECT_ID,
            chains: [BASE_SEPOLIA_CONFIG.chainId],
            rpcMap: {
                [BASE_SEPOLIA_CONFIG.chainId]: BASE_SEPOLIA_CONFIG.rpcUrl,
            },
            // V2 Provider é»˜è®¤ä¼šå¼¹å‡ºæ¨¡æ€æ¡†æ˜¾ç¤ºäºŒç»´ç 
            showQrModal: true,
            qrModalOptions: {
                themeMode: "light",
                themeVariables: {
                    '--wcm-z-index': '9999',
                },
            }
        });
        addDebugLog('WalletConnect Provider V2 åˆå§‹åŒ–æˆåŠŸ', 'success');

        updateStatus("æ­£åœ¨æ‰“å¼€é’±åŒ…è¿æ¥ Modal (æ‰«ç æˆ–é€‰æ‹©é’±åŒ…)...", 'status-pending');

        // 2. å¯ç”¨è¿æ¥
        // open() æ–¹æ³•ä¼šè‡ªåŠ¨æ˜¾ç¤º V2 Modalï¼Œç­‰å¾…ç”¨æˆ·è¿æ¥
        const accounts = await wcProvider.request({ method: "eth_requestAccounts" });

        addDebugLog('âœ… WalletConnect V2 è¿æ¥æˆåŠŸ', 'success');

        // 3. è·å–ç­¾åå™¨
        const web3Provider = new ethers.providers.Web3Provider(wcProvider);
        const signer = web3Provider.getSigner();
        const address = accounts[0]; // ä½¿ç”¨è¿æ¥åˆ°çš„ç¬¬ä¸€ä¸ªè´¦æˆ·

        addDebugLog('é’±åŒ…åœ°å€: ' + address, 'success');
        updateStatus(`âœ… é’±åŒ…å·²è¿æ¥: ${address.slice(0, 6)}...${address.slice(-4)}`, 'status-success');

        // æ£€æŸ¥ç½‘ç»œ (å¯é€‰ï¼Œä½†æ¨è)
        const network = await web3Provider.getNetwork();
        if (network.chainId !== BASE_SEPOLIA_CONFIG.chainId) {
            updateStatus(
                `âš ï¸ ç½‘ç»œä¸åŒ¹é…ï¼<br>å½“å‰: Chain ID ${network.chainId}<br>éœ€è¦: ${BASE_SEPOLIA_CONFIG.name} (${BASE_SEPOLIA_CONFIG.chainId})<br><br>è¯·åœ¨é’±åŒ…ä¸­åˆ‡æ¢ç½‘ç»œ`,
                'status-error'
            );
            setButtonState('ç½‘ç»œé”™è¯¯ - é‡æ–°è¿æ¥', false);
            return;
        }

        // 4. è¯·æ±‚ç­¾å
        updateStatus("ğŸ“ è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤ç­¾å...", 'status-pending');
        setButtonState('ç­‰å¾…ç­¾å...', true);
        addDebugLog('è¯·æ±‚ç­¾åæ¶ˆæ¯: ' + paymentMessage);

        const signature = await signer.signMessage(paymentMessage);
        addDebugLog('âœ… ç­¾åæˆåŠŸ: ' + signature.substring(0, 20) + '...', 'success');

        // 5. æäº¤ç­¾å
        updateStatus("ğŸ“¤ æ­£åœ¨æäº¤ç­¾ååˆ°æœåŠ¡å™¨...", 'status-pending');
        addDebugLog('æäº¤ç­¾ååˆ° API...');

        const submitRes = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-payment': signature,
                'x-payment-message': paymentMessage
            },
            body: JSON.stringify({ action: 'authorize' })
        });

        addDebugLog('API å“åº”çŠ¶æ€: ' + submitRes.status);

        if (submitRes.status === 200) {
            const data = await submitRes.json();
            addDebugLog('âœ… æˆæƒæˆåŠŸï¼', 'success');
            updateStatus("âœ… æˆæƒæˆåŠŸï¼", 'status-success');
            resultBox.style.display = 'block';
            resultBox.textContent = JSON.stringify(data, null, 2);
            setButtonState('æˆæƒæˆåŠŸ', true);
            // æˆæƒæˆåŠŸåæ–­å¼€è¿æ¥
            await wcProvider.disconnect();
            addDebugLog('å·²æ–­å¼€è¿æ¥', 'success');
        } else {
            let errorMsg = 'æäº¤ç­¾åå¤±è´¥';
            try {
                const errorData = await submitRes.json();
                errorMsg = errorData.message || errorMsg;
                addDebugLog('æœåŠ¡å™¨é”™è¯¯: ' + errorMsg, 'error');
            } catch (e) {
                addDebugLog('æ— æ³•è§£æé”™è¯¯å“åº”', 'error');
            }

            updateStatus(`âŒ æˆæƒå¤±è´¥: ${errorMsg}`, 'status-error');
            setButtonState('é‡æ–°è¿æ¥', false);
        }

    } catch (error) {
        // æ•è·ç”¨æˆ·å…³é—­ Modal æˆ–æ‹’ç»è¿æ¥/ç­¾åçš„é”™è¯¯
        if (wcProvider && wcProvider.disconnect) {
            await wcProvider.disconnect();
        }

        let errorMsg = 'æœªçŸ¥é”™è¯¯';
        if (error.message) {
            if (error.message.includes('User closed modal') || error.message.includes('rejected')) {
                errorMsg = 'ç”¨æˆ·å–æ¶ˆæ“ä½œ';
            } else if (error.message.includes('WalletConnectProvider')) {
                 errorMsg = `åˆå§‹åŒ–å¤±è´¥: ${error.message}`;
            } else {
                errorMsg = error.message;
            }
        }

        addDebugLog('é”™è¯¯: ' + errorMsg, 'error');
        updateStatus(`âŒ ${errorMsg}`, 'status-error');
        setButtonState('é‡æ–°è¿æ¥', false);
    }
}

// ä¸»å‡½æ•°
async function main() {
    addDebugLog('é¡µé¢åŠ è½½å®Œæˆ');
    setButtonState('åˆå§‹åŒ–ä¸­...', true);
    qrcodeDisplay.style.display = 'none'; // ç¡®ä¿äºŒç»´ç å®¹å™¨å¼€å§‹æ—¶éšè—

    const paymentMessage = await fetchPaymentMessage();

    if (paymentMessage) {
        setButtonState('è¿æ¥é’±åŒ…å¹¶ç­¾å (V2)', false);
        connectButton.onclick = () => connectAndSign(paymentMessage);
        addDebugLog('å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥ç‚¹å‡»æŒ‰é’®è¿æ¥', 'success');
    } else {
        if (!statusMessage.innerHTML.includes('å·²æˆæƒ')) {
            setButtonState('è·å–æ¶ˆæ¯å¤±è´¥', true);
        }
    }
}

// é¡µé¢åŠ è½½
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', main);
} else {
    main();
}
</script>
</body>
</html>